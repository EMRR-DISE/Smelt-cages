---
title: "Recpature distances"
author: "Rosie"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)
library(tidyverse)
library(readxl)
library(sf)
library(lubridate)
library(spacetools)
library(deltamapr)
load("Recaps.RData")
#save(nndist, distances, recaps, recaps2, recaps3, RVhdist, SCsoft, SChard, RVhdistx, Dwschard, Dwscsoft, file = "Recaps.RData")
```

## Spatial stats on Delta Smelt releases

We have four different release types and a few questions we can ask.

1. How far did smelt from each release group travel before being recaptured?
2. How variable was the distance between release and recapture?
3. How close together were fish from a particular release when they were recaptured?
4. How variable was the distance between fish on recapture?

Sam Bashevkin has written some nifty functions for calculating in=water distance between points (fish) and a reference point (release location) or between a group of points (fish from a particular release). 

https://github.com/sbashevkin/spacetools

Fist let's calcualte distance from release location to recapture location.

```{r}
#Bring in the data and check it out


recaps = read_excel("Recaptured Experimental Release_2022-2023_working draft (2).xlsx", 
                    sheet = "Full DSM Data") %>%
  rename(Site = `Release Site`, Type = `Release Type`, Latitude= `Start Latitude`, Longitude = `Start Longitude`,
         Mark = `VIE Color/Position`)
recaps    =     mutate(recaps, fishID = paste("smelt", 1:nrow(recaps)),
                Type = case_when(Type == "header" ~ "Soft",
                                 is.na(Type) ~ "Wild",
                                 TRUE ~ Type),
                Site = case_when(is.na(Site) ~ "Wild",
                                 TRUE ~ Site))
str(recaps)



```

This just needs a little data manipulation

```{r}




#Now make a data frame of the release locations
release = read_excel("releases.xlsx") %>%
  rename(LatitudeR = Latitude, LongitudeR = Longitude)
releasesf = st_as_sf(filter(release, !is.na(LatitudeR)),  coords = c("LongitudeR", "LatitudeR"), crs = 4326)

#merge recap points with release points

recaps2 = left_join(recaps, release) %>%
  mutate(DaysSinceRelease = Date - ReleaseDate)
recapsf = st_as_sf(filter(recaps2, !is.na(`Longitude`)), coords = c("Longitude", "Latitude"), crs = 4326)

#make a quick plot to make sure I did it right
ggplot()+
  geom_sf(data = WW_Delta)+
  geom_sf(data = recapsf, aes(color = Type))+
  geom_sf(data = releasesf, aes(color = Type), size = 5)+
  
  coord_sf(xlim = c(-121.5, -122.2), ylim = c(37.8, 38.5))


```


Now we can calculate the distance between each point and the release location. I'm going to do it one release at a time. THere is probalby a way to vectorize this and do it all at once, but I'm too lazy to figure it out. 

```{r, eval=FALSE}
#one release at a time
Dwschard = filter(recaps2, Type == "Hard", Site == "SDWSC")
dwsch = filter(release, Site == "SDWSC", Type == "Hard") %>%
  select(LatitudeR, LongitudeR) %>%
  rename(Latitude = LatitudeR, Longitude = LongitudeR)
tesst = GGdist(Water_map = spacetools::Delta, Points = Dwschard, Latitude_column = `Latitude`,
               Longitude_column = `Longitude`, PointID_column = fishID, EndPoint = dwsch)

#now let's do DWSC soft
Dwscsoft = filter(recaps2, Type == "Soft", Site == "SDWSC")
dwscs = filter(release, Site == "SDWSC", Type == "Soft") %>%
  select(LatitudeR, LongitudeR)%>%
  rename(Latitude = LatitudeR, Longitude = LongitudeR)
tesst2 = GGdist(Water_map = spacetools::Delta, Points = Dwscsoft, Latitude_column = `Latitude`,
               Longitude_column = `Longitude`, PointID_column = fishID, EndPoint = dwscs)

#now let's do Rio Vista hard
RVhard = filter(recaps2, Type == "Hard", Site == "Rio Vista", !is.na(Latitude))
rvh = filter(release, Site == "Rio Vista", Type == "Hard") %>%
  select(LatitudeR, LongitudeR)%>%
  rename(Latitude = LatitudeR, Longitude = LongitudeR) %>%
  distinct()
tesst3 = GGdist(Water_map = spacetools::Delta, Points = RVhard, Latitude_column = `Latitude`,
                Longitude_column = `Longitude`, PointID_column = fishID, EndPoint = rvh)

#now the trailer
RVhardt = filter(recaps2, Type == "Hard (Trailer)", Site == "Rio Vista")
rvht = filter(release, Site == "Rio Vista", Type == "Hard (Trailer)") %>%
  select(LatitudeR, LongitudeR)%>%
  rename(Latitude = LatitudeR, Longitude = LongitudeR)
tesst4 = GGdist(Water_map = spacetools::Delta, Points = RVhardt, Latitude_column = `Latitude`,
                Longitude_column = `Longitude`, PointID_column = fishID, EndPoint = rvht)

distances = bind_rows(tesst, tesst2, tesst3, tesst4)
```

OK, now let's bind all the distances together and join them back to the origional dataset

```{r}

recaps3 = left_join(recaps2, distances) %>%
  mutate(SiteType = paste(Type, Site))

recaps3

write.csv(recaps, "Recapturedistances.csv")
```

Plot to visually look at mean and variation.

```{r}
ggplot(filter(recaps3, Type != "Hard (Trailer)", Type != "Wild"), aes(x = SiteType, y = Distance))+ 
  geom_boxplot(aes(fill = SiteType))+
  ylab("Distance from Release Site (m)")+
  scale_fill_discrete(guide = NULL)+
  theme_bw()
```

Map with color variation by distance, to make sure I got it right.

```{r}
recapsf = st_as_sf(filter(recaps3, !is.na(`Longitude`)), coords = c("Longitude", "Latitude"), crs = 4326)


ggplot()+
  geom_sf(data = WW_Delta)+
  geom_sf(data = recapsf, aes(color = Distance), size =3)+
  geom_sf(data = releasesf, aes(shape = Type), size = 5)+
  scale_color_viridis_c(option = "B")+
  coord_sf(xlim = c(-121.5, -122.2), ylim = c(37.8, 38.5))

recapsum = group_by(recaps3, Site, Type, SiteType) %>%
  summarize(Nsmelt = n(), MeanDist = mean(Distance, na.rm = T), sdDist = sd(Distance, na.rm =T))

recapsum
```

```{r}

#ANOVA of differences in distance by release group
library(emmeans)
m1 = lm(Distance ~ SiteType, data = recaps3)
summary(m1)
anova(m1)
emmeans(m1, pairwise ~ SiteType)
plot(emmeans(m1, pairwise ~ SiteType), comparisons = T)

#so hard releases at RIo Vista traveled further from hard releases at SDWSC, but no other significant differences

```
```{r}

#ANOVA of differences in distance by release event
m1.1 = lm(Distance ~ ReleaseEvent, data = recaps3)
summary(m1.1)
anova(m1.1)
emmeans(m1.1, pairwise ~ ReleaseEvent)
plot(emmeans(m1.1, pairwise ~ ReleaseEvent), comparisons = T)

#It's a bit of a mess.

```


Plot of distance to recapture over time by release type

```{r}

ggplot(recaps3, aes(x = as.numeric(DaysSinceRelease), y = Distance, color = Type))+
  geom_point()+ geom_smooth(method = "lm")+ ylab("Distance from Release Site (m)")+
  xlab("Days since release")

```


Plot of distance to recapture over time by release site

```{r}

ggplot(filter(recaps3, Type == "Hard"), aes(x = as.numeric(DaysSinceRelease), y = Distance, color = Site))+
  geom_point()+ geom_smooth(method = "lm")+ ylab("Distance from Release Site (m)")+
  xlab("Days since release")

```

NOw we move on to distance bewteen recaptured fish. I'm doing it oen release at a tiem again. 

```{r, eval=FALSE}

RVhdist = Waterdist(Water_map = spacetools::Delta, Points = RVhardt, Latitude_column = `Latitude`,
                    Longitude_column = `Longitude`, PointID_column = fishID)

RVhdistx = Waterdist(Water_map = spacetools::Delta, Points = RVhard, Latitude_column = `Latitude`,
                    Longitude_column = `Longitude`, PointID_column = fishID)

SCsoft  = Waterdist(Water_map = spacetools::Delta, Points = Dwscsoft, Latitude_column = `Latitude`,
                       Longitude_column = `Longitude`, PointID_column = fishID)

SChard = Waterdist(Water_map = spacetools::Delta, Points = Dwschard, Latitude_column = `Latitude`,
                   Longitude_column = `Longitude`, PointID_column = fishID)

RVhdist
RVhdistx
SCsoft
SChard

```

Let's look at the mean of the lower triagle of each of these.

```{r}

Cluster = data.frame(Release = c("RV Hard", "RV Hard Trailer", "DWSC soft", "DWSC hard"),
                     meadist = c(mean(RVhdistx[lower.tri(RVhdistx)]), 
                                 mean(RVhdist[lower.tri(RVhdist)]), 
                                 mean(SCsoft[lower.tri(SCsoft)]), 
                                 mean(SChard[lower.tri(SChard)])),
                     SD = c(sd(RVhdistx), sd(RVhdist), sd(SCsoft), sd(SChard)))

Cluster = mutate(Cluster, CV = SD/meadist)
Cluster
```

OK, now how to I put these all together to graph them?

```{r}

RVhdistx[lower.tri(RVhdistx, diag = T)] = NA
RVhdist[lower.tri(RVhdist, diag = T)] = NA
SCsoft[lower.tri(SCsoft, diag = T)] = NA
SChard[lower.tri(SChard, diag = T)] = NA
RVdtx = as.data.frame(RVhdistx) %>%
  mutate(Fish1 = row.names(RVhdistx)) %>%
  pivot_longer(cols = -Fish1, names_to = "Fish2", values_to = "Distance") %>%
  filter(!is.na(Distance)) %>%
  mutate(Release = "Rio Vista Hard")

RVdt = as.data.frame(RVhdist) %>%
  mutate(Fish1 = row.names(RVhdist)) %>%
  pivot_longer(cols = -Fish1, names_to = "Fish2", values_to = "Distance") %>%
  filter(!is.na(Distance)) %>%
  mutate(Release = "Trailer")

SCs = as.data.frame(SCsoft) %>%
  mutate(Fish1 = row.names(SCsoft)) %>%
  pivot_longer(cols = -Fish1, names_to = "Fish2", values_to = "Distance") %>%
  filter(!is.na(Distance)) %>%
  mutate(Release = "DWSC Soft")

SCh = as.data.frame(SChard) %>%
  mutate(Fish1 = row.names(SChard)) %>%
  pivot_longer(cols = -Fish1, names_to = "Fish2", values_to = "Distance") %>%
  filter(!is.na(Distance)) %>%
  mutate(Release = "DWSC Hard")


nndist = bind_rows(RVdtx, RVdt, SCs, SCh) %>%
  mutate(Release = factor(Release, levels = c("Rio Vista Hard", "DWSC Hard", "DWSC Soft", "Trailer"),
                          labels = c("Hard Rio Vista", "Hard SDWSC", "Soft SWDSC", "Trailer")))


ggplot(filter(nndist, Release != "Trailer"), aes(x = Release, y = Distance, fill = Release)) + geom_boxplot()+
  ylab("Distance Between Recaptures")+ theme_bw()+ scale_fill_discrete(guide = NULL)

```

now let's look at it statistically

```{r}

m2 = lm(Distance ~ Release, data = nndist)
summary(m2)
plot(m2)
#QQ plot is a bit of a mess I tried log-transforming and sqrt transforming and its still a mess. 

emmeans(m2, pairwise ~ Release)
plot(emmeans(m2, pairwise ~ Release), comparisons = T)

```

So DWSC soft were closer together than rio vista hard, but no difference between DWSC hard and DWSC soft

I could also do this by release rather than release type

```{r}
smeltIDS = select(recaps2, fishID, ReleaseEvent)

nndist2 = left_join(nndist, smeltIDS, by = c("Fish1" = "fishID"))

m3 = lm(Distance ~ ReleaseEvent, data = nndist2)
summary(m3)
plot(m3)
#QQ plot is a bit of a mess I tried log-transforming and sqrt transforming and its still a mess. 

emmeans(m3, pairwise ~ ReleaseEvent)
plot(emmeans(m3, pairwise ~ ReleaseEvent), comparisons = T)

write.csv(nndist2, "DistanceMatrix.csv")
```

